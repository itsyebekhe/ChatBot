<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Make it responsive and prevent zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- PWA & Mobile App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- Or "default" or "black" -->
    <meta name="apple-mobile-web-app-title" content="Gemma Chat">
    <meta name="application-name" content="Gemma Chat">
    <meta name="theme-color" content="#0d6efd"> <!-- Match manifest theme_color -->

    <!-- Link to Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons (replace with your actual icon paths) -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> <!-- Typically 180x180 -->


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>Gemma Chat</title>
    <style>
        /* --- General Reset & Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%;
            /* Prevent pull-to-refresh slightly */
            overscroll-behavior-y: contain;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; /* System fonts */
            height: 100%; /* Full viewport height */
            display: flex;
            flex-direction: column; /* Stack header, body, footer vertically */
            background: #e9ecef;
            color: #212529;
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.4;
            overflow: hidden; /* Prevent body scrolling */
        }

        /* --- Theme: Dark Mode --- */
        body.dark {
            background: #212529;
            color: #f8f9fa;
        }
        .dark .chat-wrapper { background: #212529; /* Match body */ }
        .dark .chat-header { background: #343a40; border-bottom-color: #495057; }
        .dark .chat-footer { background: #343a40; border-top-color: #495057; }
        .dark .ai-msg { background: #495057; color: #f8f9fa; border-color: #6c757d; }
        .dark .ai-msg code, .dark .ai-msg pre { background: #6c757d; }
        .dark input[type="text"], .dark #api-key-input { background: #495057; color: #f8f9fa; border-color: #6c757d; }
        .dark button { /* Ensure buttons visible in dark mode */ }
        .dark .thinking { background: #495057; } /* Give thinking a bg */
        .dark .dot { background: #dee2e6; } /* Lighter dots */


        /* --- Layout: Chat Wrapper (Now the main layout container) --- */
        /* The .chat-wrapper is less important now, body handles the main layout */
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Takes up all space in the body flex container */
            overflow: hidden; /* Redundant due to body, but safe */
            height: 100%; /* Ensure it fills the body */
        }

        /* --- Components: Header (Fixed/Sticky) --- */
        .chat-header {
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            flex-shrink: 0; /* Prevent shrinking */
            position: sticky; /* Keep at top */
            top: 0;
            background: #ffffff; /* Needs explicit background */
            z-index: 10; /* Above scrolling content */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Optional shadow */
        }
        .dark .chat-header { background: #343a40; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }


        .chat-header h1 {
            font-size: 1.1rem; /* Slightly smaller for app feel */
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* --- Components: Chat Body (Scrollable) --- */
        .chat-body {
            flex-grow: 1; /* Takes available space between header/footer */
            padding: 15px 15px 5px 15px; /* Add padding bottom to avoid footer overlap */
            overflow-y: auto; /* Enable vertical scrolling ONLY here */
            scroll-behavior: smooth;
            overscroll-behavior-y: contain; /* Prevent overscroll effects */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* --- Components: Messages --- */
        .message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 12px; /* Slightly more rounded */
            max-width: 80%;
            line-height: 1.45; /* Slightly more spacing */
            animation: fadeIn 0.3s ease;
            font-size: 0.95rem; /* Slightly larger for readability */
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .dark .message { box-shadow: none; }

        .user-msg {
            background: #0d6efd;
            color: #fff;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 4px; /* Common chat bubble style */
        }
        .dark .user-msg { background: #0b5ed7; } /* Slightly adjusted dark blue */


        .ai-msg {
            background: #f1f3f5;
            color: #212529;
            /* Remove border for cleaner look */
            /* border: 1px solid #dee2e6; */
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 4px; /* Common chat bubble style */
        }
        .dark .ai-msg {
            background: #495057;
            color: #f8f9fa;
        }

        /* Markdown Styles */
        .ai-msg p:last-child { margin-bottom: 0; }
        .ai-msg p { margin: 0 0 8px; }
        .ai-msg ul, .ai-msg ol { margin: 5px 0 8px 20px; padding-left: 15px; }
        .ai-msg li { margin: 4px 0; }
        .ai-msg strong { font-weight: 600; } /* Slightly less bold */
        .ai-msg em { font-style: italic; }
        .ai-msg code {
            background: #e0e0e0; /* Slightly darker code bg */
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* Monospace fonts */
            font-size: 0.88em;
        }
        .ai-msg pre {
             background: #e9ecef;
             padding: 10px; /* More padding */
             border-radius: 6px; /* More rounded */
             overflow-x: auto;
             margin: 10px 0;
             border: 1px solid #dee2e6; /* Add border to code blocks */
        }
         .dark .ai-msg pre { border-color: #555; }
         .ai-msg pre code { background: none; padding: 0; border-radius: 0; font-size: 1em; border: none;}

        /* Thinking Indicator */
        .thinking {
            display: flex;
            align-items: center;
            gap: 6px; /* More gap */
            padding: 10px 12px; /* Match message padding better */
            margin: 8px 0;
            max-width: fit-content;
            margin-right: auto;
            background: #f1f3f5; /* Match AI msg bg */
            border-radius: 12px;
            border-bottom-left-radius: 4px;
        }
        .dot {
            width: 7px; /* Slightly larger dots */
            height: 7px;
            background: #adb5bd; /* Grey dots */
            border-radius: 50%;
            animation: bounce 1.3s infinite ease-in-out;
        }
        .dot:nth-child(2) { animation-delay: 0.16s; }
        .dot:nth-child(3) { animation-delay: 0.32s; }

        /* --- Components: Footer (Fixed/Sticky) --- */
        .chat-footer {
            padding: 8px 10px; /* Reduced padding a bit */
            border-top: 1px solid #dee2e6;
            background: #ffffff; /* Explicit background */
            display: flex;
            flex-direction: column; /* Stack API key and input row */
            gap: 5px;
            flex-shrink: 0; /* Prevent shrinking */
            position: sticky; /* Keep at bottom */
            bottom: 0;
            z-index: 10; /* Above content */
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05); /* Optional shadow */
        }
        .dark .chat-footer { background: #343a40; box-shadow: 0 -1px 3px rgba(0,0,0,0.2); }

        .api-key-row, .input-row {
            display: flex;
            gap: 5px;
            width: 100%; /* Take full width */
        }

        /* --- Components: Inputs & Buttons --- */
        input[type="text"],
        #api-key-input {
            flex-grow: 1; /* Take available space */
            padding: 10px 12px; /* More padding for touch */
            border: 1px solid #ced4da;
            border-radius: 20px; /* Pill shape */
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            min-width: 100px;
            height: 40px; /* Taller for touch */
            background-color: #f1f3f5; /* Match AI msg background */
            border: none; /* Remove border */
        }
        .dark input[type="text"], .dark #api-key-input { background-color: #495057; }


        input:focus,
        #api-key-input:focus {
            outline: none;
            /* Use box-shadow for focus instead of border */
             box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3);
        }

        button {
            padding: 0 15px; /* More horizontal padding */
            height: 40px; /* Match input height */
            background: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 20px; /* Pill shape */
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background 0.2s ease, transform 0.1s ease; /* Faster transform */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent buttons shrinking too much */
        }

        button:hover {
            background: #0a58ca;
            /* Remove transform on hover for app feel */
            /* transform: translateY(-1px); */
        }
        button:active {
             transform: scale(0.97); /* Slight scale down on tap */
             background: #0a58ca;
        }

        #clear-btn { background: #6c757d; } /* Muted clear button */
        #clear-btn:hover { background: #5c636a; }
        #clear-btn:active { background: #5c636a; }


        #api-btn { background: #198754; min-width: 80px; } /* Give "Get Key" more width */
        #api-btn:hover { background: #157347; }
        #api-btn:active { background: #157347; }


        #file-btn {
            background: #6c757d;
            min-width: 40px; /* Keep it square-ish */
            padding: 0;
            font-size: 1.3rem; /* Larger icon */
            line-height: 1;
            border-radius: 50%; /* Circular button */
        }
        #file-btn:hover { background: #5c636a; }
        #file-btn:active { background: #5c636a; }


        #send-btn {
            min-width: 40px; /* Make send button potentially circular if text removed */
            padding: 0;
            border-radius: 50%; /* Circular */
             /* Add Send Icon (e.g., SVG or Font Awesome) inside the button in HTML if desired */
             /* Example: Replace "Send" text with an icon */
             font-size: 1.5rem; /* Adjust if using icon font */
        }

        #file-input { display: none; }

        /* --- Utilities: RTL Support --- */
        /* RTL styles should remain largely the same, check alignment */
        .rtl { direction: rtl; }
        .rtl .message { margin-left: 0; margin-right: auto; text-align: right; }
        .rtl .user-msg { margin-right: auto; margin-left: 0; text-align: left; border-bottom-right-radius: 12px; border-bottom-left-radius: 4px;}
        .rtl .ai-msg { margin-left: auto; margin-right: 0; text-align: right; border-bottom-left-radius: 12px; border-bottom-right-radius: 4px;}
        .rtl .thinking { margin-left: auto; margin-right: 0;}
        .rtl input[type="text"], .rtl #api-key-input { /* Text input already handles RTL */ }


        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Adjusted Bounce Animation */
        @keyframes bounce {
            0%, 70%, 100% { transform: scale(0.5); opacity: 0.5; }
            35% { transform: scale(1.0); opacity: 1; }
        }

    </style>
</head>
<body class="${localStorage.getItem('theme') === 'dark' ? 'dark' : ''}">

    <!-- Main Chat Application Wrapper -->
    <div class="chat-wrapper">

        <!-- Chat Header: Title and Controls (Sticky Top) -->
        <div class="chat-header">
            <h1 data-en="Gemma Chat" data-fa="Ú†Øª Ù†ÙˆØ§">Gemma Chat</h1>
            <div class="controls">
                <button id="theme-btn" data-en="Dark" data-fa="ØªØ§Ø±ÛŒÚ©">
                    ${localStorage.getItem('theme') === 'dark' ? (localStorage.getItem('lang') === 'fa' ? 'Ø±ÙˆØ´Ù†' : 'Light') : (localStorage.getItem('lang') === 'fa' ? 'ØªØ§Ø±ÛŒÚ©' : 'Dark')}
                </button>
                <button id="lang-btn" data-en="Persian" data-fa="Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ">
                    ${localStorage.getItem('lang') === 'fa' ? 'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ' : 'Persian'}
                </button>
                <button id="clear-btn" data-en="Clear Chat" data-fa="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª">Clear Chat</button>
            </div>
        </div>

        <!-- Chat Messages Area (Scrollable) -->
        <div class="chat-body" id="chat-body">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Chat Input Footer (Sticky Bottom) -->
        <div class="chat-footer">
            <!-- API Key Row -->
            <div class="api-key-row">
                 <input type="text" id="api-key-input"
                       placeholder="OpenRouter API Key"
                       data-en-placeholder="OpenRouter API Key"
                       data-fa-placeholder="Ú©Ù„ÛŒØ¯ API OpenRouter"
                       value="${localStorage.getItem('apiKey') || ''}">
                <button id="api-btn" data-en="Get Key" data-fa="Ú©Ù„ÛŒØ¯">Key</button> <!-- Shorter Text -->
            </div>
            <!-- Input Row -->
            <div class="input-row">
                <button id="file-btn" title="Attach file">ðŸ“Ž</button>
                <input type="text" id="chat-input"
                       placeholder="Type your message..."
                       data-en-placeholder="Type your message..."
                       data-fa-placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯...">
                <!-- Send Button (Consider using an icon) -->
                <button id="send-btn" title="Send message">
                     <!-- Replace text with SVG/Icon Font for better PWA look -->
                     <!-- Example: <svg>...</svg> or <i class="fas fa-paper-plane"></i> -->
                     âž¤ <!-- Simple arrow placeholder -->
                 </button>
                <input type="file" id="file-input" accept="image/*,application/pdf,text/plain">
            </div>
        </div>

    </div><!-- /.chat-wrapper -->

    <script>
        // IIFE to encapsulate chat logic and avoid global scope pollution
        (function() {
            "use strict"; // Enable strict mode

            // --- State Variables ---
            let conversation = JSON.parse(localStorage.getItem('conversation')) || [];
            let apiKey = localStorage.getItem('apiKey') || '';
            let isTyping = false; // Flag to prevent multiple simultaneous requests
            let isDark = localStorage.getItem('theme') === 'dark';
            let isPersian = localStorage.getItem('lang') === 'fa';

            // --- DOM Element References ---
            const chatBody = document.getElementById('chat-body');
            const apiKeyInput = document.getElementById('api-key-input');
            const chatInput = document.getElementById('chat-input');
            const fileInput = document.getElementById('file-input');
            const themeBtn = document.getElementById('theme-btn');
            const langBtn = document.getElementById('lang-btn');
            const clearBtn = document.getElementById('clear-btn');
            const apiBtn = document.getElementById('api-btn');
            const sendBtn = document.getElementById('send-btn');
            const fileBtn = document.getElementById('file-btn');
            const sendBtnElement = document.getElementById('send-btn'); // Specific ref for text change

            // --- Core Functions ---

            /**
             * Updates the UI based on the current theme and language settings.
             */
            function updateUI() {
                document.body.classList.toggle('dark', isDark);
                document.body.classList.toggle('rtl', isPersian);

                document.querySelectorAll('[data-en]').forEach(el => {
                    // Handle buttons specifically if they contain only icons later
                    if (el.id !== 'send-btn') { // Don't overwrite send button icon/text here
                         el.textContent = isPersian ? el.getAttribute('data-fa') : el.getAttribute('data-en');
                    }
                });

                document.querySelectorAll('[data-en-placeholder]').forEach(el => {
                    el.placeholder = isPersian ? el.getAttribute('data-fa-placeholder') : el.getAttribute('data-en-placeholder');
                });

                themeBtn.textContent = isDark
                    ? (isPersian ? 'Ø±ÙˆØ´Ù†' : 'Light')
                    : (isPersian ? 'ØªØ§Ø±ÛŒÚ©' : 'Dark');
                langBtn.textContent = isPersian ? 'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ' : 'Persian';

                // Update button text/content that might change based on language but isn't icon-only
                 apiBtn.textContent = isPersian ? 'Ú©Ù„ÛŒØ¯' : 'Key'; // Using shorter text now
                 clearBtn.textContent = isPersian ? (window.innerWidth < 400 ? 'Ù¾Ø§Ú©' : 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª') : (window.innerWidth < 400 ? 'Clear' : 'Clear Chat'); // Example responsive text

                 // Update Send button title/tooltip if needed
                 sendBtnElement.title = isPersian ? 'Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…' : 'Send message';

                // Update theme-color meta tag
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (themeColorMeta) {
                    themeColorMeta.content = isDark ? '#343a40' : '#0d6efd';
                }
            }


            /**
             * Scrolls the chat body to the bottom smoothly.
             */
            function scrollToBottom() {
                // Use timeout to ensure DOM has updated after adding message/thinking
                setTimeout(() => {
                     chatBody.scrollTo({
                        top: chatBody.scrollHeight,
                        behavior: 'smooth'
                     });
                }, 50); // Short delay
            }


            /**
             * Loads the conversation history from localStorage and renders messages.
             */
            function loadConversation() {
                chatBody.innerHTML = ''; // Clear existing messages
                let needsScroll = conversation.length > 0; // Only scroll if there are messages

                conversation.forEach(msg => {
                    const isUser = msg.role === 'user';
                    let displayContent = '[Message content unavailable]';
                    if (Array.isArray(msg.content) && msg.content.length > 0) {
                         const firstPart = msg.content[0];
                         if (firstPart.type === 'text') { displayContent = firstPart.text; }
                         else if (firstPart.type === 'image_url') { displayContent = isPersian ? '[ØªØµÙˆÛŒØ± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯]' : '[Image loaded]'; }
                    } else if (typeof msg.content === 'string') { displayContent = msg.content; }
                    addMessage(displayContent, isUser, false); // Add message without animation/scroll on load
                });
                apiKeyInput.value = apiKey;
                updateUI();

                // Scroll to bottom only after loading everything and if needed
                if (needsScroll) {
                    setTimeout(() => {
                         chatBody.scrollTop = chatBody.scrollHeight; // Instant scroll on load
                    }, 100); // Slightly longer delay on load
                }
            }

            /**
             * Adds a message bubble to the chat body.
             * @param {string} content - The message text or description.
             * @param {boolean} [isUser=false] - True if the message is from the user.
             * @param {boolean} [shouldScroll=true] - True to scroll the new message into view.
             */
            function addMessage(content, isUser = false, shouldScroll = true) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${isUser ? 'user-msg' : 'ai-msg'}`;

                if (isUser) {
                    msgDiv.textContent = content;
                } else {
                    if (typeof marked !== 'undefined') {
                         marked.setOptions({ breaks: true, gfm: true }); // Enable GitHub Flavored Markdown
                         msgDiv.innerHTML = marked.parse(content || '');
                    } else {
                         console.error("Marked library not loaded.");
                         msgDiv.textContent = content;
                    }
                }

                chatBody.appendChild(msgDiv);

                if (shouldScroll) {
                    scrollToBottom(); // Use the dedicated scroll function
                }
            }

            /**
             * Adds a "thinking" animation.
             * @returns {HTMLElement} The thinking indicator element.
             */
            function addThinking() {
                 const existingThinking = chatBody.querySelector('.thinking');
                 if(existingThinking) { removeThinking(existingThinking); }

                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'thinking'; // Removed ai-msg class styling is separate now
                thinkingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                chatBody.appendChild(thinkingDiv);
                scrollToBottom();
                return thinkingDiv;
            }

            /**
             * Removes the thinking indicator element.
             * @param {HTMLElement} thinkingElement - The element to remove.
             */
            function removeThinking(thinkingElement) {
                if (thinkingElement && thinkingElement.parentNode === chatBody) {
                    chatBody.removeChild(thinkingElement);
                }
            }

            /**
             * Saves the current state to localStorage.
             */
            function saveState() {
                try {
                    localStorage.setItem('conversation', JSON.stringify(conversation));
                    localStorage.setItem('apiKey', apiKey);
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    localStorage.setItem('lang', isPersian ? 'fa' : 'en');
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                    addMessage(isPersian ? "Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ú†Øª." : "Error saving chat state.", false);
                }
            }

            /**
             * Converts a file to a Base64 encoded string.
             * @param {File} file - The file to convert.
             * @returns {Promise<string>} A promise resolving with the Base64 data URL.
             */
            function getBase64(file) {
                // Same as before
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            /**
             * Sends the user's message (text and/or file) to the OpenRouter API.
             * @param {File} [file=null] - An optional file to upload.
             */
            async function sendMessage(file = null) {
                if (isTyping) return;

                apiKey = apiKeyInput.value.trim();
                const messageText = chatInput.value.trim();

                if (!apiKey) {
                    addMessage(isPersian ? 'Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ API OpenRouter Ù…Ø¹ØªØ¨Ø± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.' : 'Please enter your valid OpenRouter API key.', false);
                    apiKeyInput.focus(); // Focus the API key input
                    return;
                }
                if (!messageText && !file) {
                    return;
                }

                isTyping = true;
                sendBtn.disabled = true;
                chatInput.disabled = true;
                fileBtn.disabled = true;
                apiKeyInput.disabled = true; // Disable API key input during request


                let thinkingIndicator; // Declare here

                // --- Prepare Message Payload ---
                let currentMessageContent = [];
                let userDisplayMessageAdded = false; // Track if user message bubble was added

                // Handle text message part
                if (messageText) {
                    currentMessageContent.push({ type: 'text', text: messageText });
                    addMessage(messageText, true); // Add user text message immediately
                    userDisplayMessageAdded = true;
                    chatInput.value = '';
                }

                // Handle file part
                if (file) {
                    try {
                        const base64Data = await getBase64(file);
                        const fileType = file.type;
                        let fileDescription = "";

                        if (fileType.startsWith('image/')) {
                             currentMessageContent.push({ type: 'image_url', image_url: { url: base64Data } });
                             fileDescription = isPersian ? `[ØªØµÙˆÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${file.name}]` : `[Image sent: ${file.name}]`;
                        } else if (fileType === 'application/pdf' || fileType === 'text/plain') {
                            currentMessageContent.push({ type: 'text', text: `[User uploaded file: ${file.name}, type: ${fileType}]` });
                             fileDescription = isPersian ? `[ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${file.name}]` : `[File sent: ${file.name}]`;
                        } else {
                            addMessage(isPersian ? `Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯: ${fileType}` : `Unsupported file type: ${fileType}`, false);
                            // No thinking indicator added yet, just reset state
                            isTyping = false;
                            sendBtn.disabled = false;
                            chatInput.disabled = false;
                            fileBtn.disabled = false;
                            apiKeyInput.disabled = false;
                            return;
                        }

                        // Add a message bubble *only* for the file if no text was sent
                        if (!userDisplayMessageAdded && fileDescription) {
                             addMessage(fileDescription, true);
                             userDisplayMessageAdded = true; // Mark that a user bubble was shown
                        } else {
                             console.log("File sent along with text message:", file.name);
                        }

                        fileInput.value = '';

                    } catch (error) {
                        console.error("File processing error:", error);
                        addMessage(isPersian ? `Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„: ${error.message}` : `File processing error: ${error.message}`, false);
                        // Reset state if error occurs during file processing
                        isTyping = false;
                        sendBtn.disabled = false;
                        chatInput.disabled = false;
                        fileBtn.disabled = false;
                        apiKeyInput.disabled = false;
                        return;
                    }
                }

                // Add thinking indicator *after* user message is prepared/added
                thinkingIndicator = addThinking();

                // Add the complete user message structure to conversation history
                const userMsg = { role: 'user', content: currentMessageContent };
                conversation.push(userMsg);
                saveState();

                // --- API Call ---
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin, // Use origin
                            'X-Title': 'Gemma Chat PWA', // Updated title
                        },
                        body: JSON.stringify({
                            model: 'google/gemma-3-27b-it:free',
                            messages: conversation,
                        }),
                    });

                    removeThinking(thinkingIndicator); // Remove indicator

                    if (!response.ok) {
                        let errorDetails = `API Error (${response.status})`;
                        try {
                            const errorData = await response.json();
                            errorDetails += `: ${errorData.error?.message || response.statusText}`;
                        } catch (jsonError) {
                            errorDetails += `: ${await response.text()}`;
                        }
                        throw new Error(errorDetails);
                    }

                    const data = await response.json();

                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        const aiContent = data.choices[0].message.content;
                        const aiMsg = { role: 'assistant', content: [{ type: 'text', text: aiContent }] };
                        conversation.push(aiMsg);
                        addMessage(aiContent, false); // Add AI message (will scroll)
                        saveState();
                    } else {
                        throw new Error("Invalid response structure received from API.");
                    }

                } catch (error) {
                    console.error("API Request Error:", error);
                    if (thinkingIndicator) removeThinking(thinkingIndicator); // Ensure removed on error
                    addMessage(isPersian ? `Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ${error.message}` : `Error communicating with server: ${error.message}`, false);
                } finally {
                    // --- Reset State ---
                    isTyping = false;
                    sendBtn.disabled = false;
                    chatInput.disabled = false;
                    fileBtn.disabled = false;
                    apiKeyInput.disabled = false; // Re-enable API key input
                    chatInput.focus();
                }
            }

            // --- Event Listeners ---

            sendBtn.addEventListener('click', () => sendMessage());
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            fileBtn.addEventListener('click', () => { fileInput.click(); });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) { sendMessage(file); }
            });

            clearBtn.addEventListener('click', () => {
                if (confirm(isPersian ? "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ" : "Are you sure you want to clear the entire chat history?")) {
                     conversation = [];
                     chatBody.innerHTML = ''; // Clear messages
                     localStorage.removeItem('conversation');
                     saveState(); // Save empty state
                }
            });

            themeBtn.addEventListener('click', () => {
                isDark = !isDark;
                updateUI();
                saveState();
            });

            langBtn.addEventListener('click', () => {
                isPersian = !isPersian;
                updateUI();
                saveState();
            });

            apiBtn.addEventListener('click', () => {
                window.open('https://openrouter.ai/settings/keys', '_blank', 'noopener noreferrer');
            });

            // --- Initialization ---
            window.addEventListener('load', loadConversation);

            // Optional: Update UI on resize (e.g., for responsive button text)
             let resizeTimeout;
             window.addEventListener('resize', () => {
                 clearTimeout(resizeTimeout);
                 resizeTimeout = setTimeout(updateUI, 150); // Debounce resize updates
             });


        })(); // End of IIFE
    </script>
</body>
</html>
